zset

Keyspace Notifications

ordered set: ziplist, skiplist, or balanced trees

### Zhihu's redis clusters

* 70TB total memory, used 40 TB
* 15M rps across the cluster
* single cluster 4M rps peak
* 800 clusters
* 20G storage or 200k rps - use cluster mode

Standalone: sentinel to do health check, raft to elect leaders, normally just 1 slave for standby, may add more read only slaves for r-w seperation 

Twemproxy by twitter

on restart, clear the cache to avoid dirty cache conflict with the old cache data


### official cluster
hash the key into 16384 Slots, user will assign slots to shard, on expanding, user will choose slots and MIGRATE keys in the slots. - All in sync, so will be in BLOCK mode -> cause p95 pikes or even failover for HUGE keys (> 1 MB) -

Client visiting migrating key will have to ASK twice.

These problems are motivation for non blocking MIGRATE

maxmemory

migration: SYNC/PSYNC, fork a process to iterate all RDB files and send to slave, all writes recieives will be buffered in memory, and will be sent to slave AFER all RDB files are transferred

1TB Resharding - 30 mins

Redis single thread means that MONITOR will make the CPU usage even higher under high CPU load

setNx(set if not exist) - nx and ex

Redlock - Redission

implemented by select, poll, epoll

CPU is rarely the bottle neck - network and memory most likely yes



redis snapshot BGSAVE and SAVE, AOF
